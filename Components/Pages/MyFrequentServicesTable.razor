@page "/my-frequent-services-table"
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms
@inject IJSRuntime JSRuntime
@using BlazorAzureServices.Services
@inject ConfigurationService ConfigurationService

<PageTitle>My Frequent Azure Services - Table View</PageTitle>

<div class="container">
    <div class="back-nav">
        <a href="azure-services" class="back-btn">‚Üê Back to All Services</a>
        <a href="my-frequent-services" class="back-btn" style="margin-left: 10px;">üìã List View</a>
    </div>

    <header>
        <h1>My Frequent Azure Services - Table View</h1>
        <p class="subtitle">Quick access to your most used Azure resources in table format</p>
    </header>

    @if (isLoading)
    {
        <div class="loading">Loading services...</div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="error">@errorMessage</div>
    }
    else
    {
        @foreach (var serviceSection in serviceSections)
        {
            <div class="service-section">
                <div class="section-title" style="cursor: pointer;" @onclick="() => ToggleSection(serviceSection.Type)">
                    <div class="section-info">
                        <span class="section-icon">@(serviceSection.Icon)</span>
                        @serviceSection.Name
                        <span class="toggle-icon">@(serviceSection.IsExpanded ? "‚ñº" : "‚ñ∂")</span>
                    </div>
                    <button class="add-btn" @onclick="() => OpenAddModal(serviceSection.Type)" @onclick:stopPropagation="true">+ Add @serviceSection.AddButtonText</button>
                </div>
                <div class="table-container @(serviceSection.IsExpanded ? "" : "collapsed")">
                    <table class="services-table">
                        <thead>
                            <tr>
                                @foreach (var header in serviceSection.TableHeaders)
                                {
                                    <th>@header</th>
                                }
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var resource in serviceSection.Resources)
                            {
                                <tr @onclick="() => NavigateToResource(resource.Url)">
                                    <td>
                                        <div class="table-service-name">
                                            <span class="table-service-icon">@resource.Icon</span>
                                            @resource.Name
                                            @if (!string.IsNullOrEmpty(resource.Tag))
                                            {
                                                <span class="table-tag @resource.Tag.ToLower()">@resource.Tag</span>
                                            }
                                        </div>
                                    </td>
                                    <td>@resource.Type</td>
                                    <td>@resource.ResourceGroup</td>
                                    <td>@resource.Location</td>
                                    <td>@resource.TierOrRuntime</td>
                                    @if (serviceSection.ShowExtraColumn)
                                    {
                                        <td>
                                            @if (serviceSection.Type == "apimanagement" && !string.IsNullOrEmpty(resource.ExtraColumn))
                                            {
                                                <button type="button" class="table-btn dev-portal" @onclick="() => NavigateToDevPortal(resource)" @onclick:stopPropagation="true">Open Portal</button>
                                            }
                                            else
                                            {
                                                @resource.ExtraColumn
                                            }
                                        </td>
                                    }
                                    <td><span class="table-status @resource.StatusClass">@resource.Status</span></td>
                                    <td>
                                        <div class="table-actions">
                                            <button type="button" class="table-btn view" @onclick="() => NavigateToResource(resource.Url)" @onclick:stopPropagation="true">View</button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
    }
</div>

<!-- Add Resource Modal -->
<div class="modal @(showModal ? "show" : "")" style="display: @(showModal ? "block" : "none")">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">@modalTitle</h2>
        </div>
        <EditForm Model="newResource" OnValidSubmit="HandleAddResource">
            <DataAnnotationsValidator />
            <div class="form-group">
                <label class="form-label">Resource Name</label>
                <InputText class="form-control" @bind-Value="newResource.Name" required />
                <ValidationMessage For="@(() => newResource.Name)" />
            </div>
            <div class="form-group">
                <label class="form-label">Resource Group</label>
                <InputText class="form-control" @bind-Value="newResource.ResourceGroup" required />
                <ValidationMessage For="@(() => newResource.ResourceGroup)" />
            </div>
            <div class="form-group">
                <label class="form-label">Location</label>
                <InputSelect class="form-control" @bind-Value="newResource.Location" required>
                    <option value="">Select Location</option>
                    <option value="East US">East US</option>
                    <option value="West US">West US</option>
                    <option value="Central US">Central US</option>
                    <option value="North Europe">North Europe</option>
                    <option value="West Europe">West Europe</option>
                </InputSelect>
                <ValidationMessage For="@(() => newResource.Location)" />
            </div>
            @if (showRuntimeField)
            {
                <div class="form-group">
                    <label class="form-label">Runtime</label>
                    <InputSelect class="form-control" @bind-Value="newResource.TierOrRuntime">
                        <option value="">Select Runtime</option>
                        <option value=".NET 6">.NET 6</option>
                        <option value=".NET 8">.NET 8</option>
                        <option value="Node.js 18">Node.js 18</option>
                        <option value="Python 3.9">Python 3.9</option>
                        <option value="Java 11">Java 11</option>
                    </InputSelect>
                </div>
            }
            <div class="modal-actions">
                <button type="button" class="btn-secondary" @onclick="CloseModal">Cancel</button>
                <button type="submit" class="btn-primary">Add Resource</button>
            </div>
        </EditForm>
    </div>
</div>

@code {
    private List<ServiceTableSection> serviceSections = new();
    private bool showModal = false;
    private bool showRuntimeField = false;
    private string modalTitle = "";
    private string currentServiceType = "";
    private NewResourceModel newResource = new();
    private bool isLoading = true;
    private string errorMessage = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadServiceSections();
    }

    private async Task LoadServiceSections()
    {
        try
        {
            isLoading = true;
            serviceSections = await ConfigurationService.LoadServiceSectionsAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading services: {ex.Message}";
            Console.WriteLine(errorMessage);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void ToggleSection(string sectionType)
    {
        var section = serviceSections.FirstOrDefault(s => s.Type == sectionType);
        if (section != null)
        {
            section.IsExpanded = !section.IsExpanded;
            StateHasChanged();
        }
    }

    private void OpenAddModal(string serviceType)
    {
        currentServiceType = serviceType;
        var section = serviceSections.FirstOrDefault(s => s.Type == serviceType);
        if (section != null)
        {
            modalTitle = $"Add New {section.AddButtonText}";
            showRuntimeField = serviceType == "functions" || serviceType == "appservices";
            newResource = new NewResourceModel();
            showModal = true;
        }
    }

    private void CloseModal()
    {
        showModal = false;
        newResource = new NewResourceModel();
    }

    private void HandleAddResource()
    {
        var section = serviceSections.FirstOrDefault(s => s.Type == currentServiceType);
        if (section != null)
        {
            var serviceConfig = GetServiceConfig(currentServiceType);
            
            var newResourceItem = new TableResourceItem
            {
                Name = newResource.Name,
                Icon = serviceConfig.Icon,
                Type = serviceConfig.Title,
                ResourceGroup = newResource.ResourceGroup,
                Location = newResource.Location,
                TierOrRuntime = GetTierOrRuntime(currentServiceType, newResource.TierOrRuntime),
                Status = GetDefaultStatus(currentServiceType),
                StatusClass = "running"
            };

            section.Resources.Add(newResourceItem);
        }

        CloseModal();
    }

    private async Task NavigateToResource(string? url)
    {
        if (!string.IsNullOrEmpty(url))
        {
            await JSRuntime.InvokeVoidAsync("window.open", url, "_blank");
        }
    }

    private async Task NavigateToDevPortal(TableResourceItem resource)
    {
        // For API Management services, construct the developer portal URL
        if (!string.IsNullOrEmpty(resource.Name))
        {
            // Typical Azure API Management developer portal URL pattern
            var devPortalUrl = $"https://{resource.Name}.developer.azure-api.net";
            await JSRuntime.InvokeVoidAsync("window.open", devPortalUrl, "_blank");
        }
    }

    private ServiceConfig GetServiceConfig(string serviceType)
    {
        var configs = new Dictionary<string, ServiceConfig>
        {
            ["functions"] = new ServiceConfig { Title = "Function App", Icon = "‚ö°" },
            ["appservices"] = new ServiceConfig { Title = "App Service", Icon = "üåê" },
            ["storage"] = new ServiceConfig { Title = "Storage Account", Icon = "üíæ" },
            ["cosmosdb"] = new ServiceConfig { Title = "Cosmos DB", Icon = "üåê" },
            ["apimanagement"] = new ServiceConfig { Title = "API Management", Icon = "üîå" },
            ["keyvault"] = new ServiceConfig { Title = "Key Vault", Icon = "üóùÔ∏è" },
            ["appinsights"] = new ServiceConfig { Title = "Application Insights", Icon = "üìä" }
        };

        return configs.GetValueOrDefault(serviceType, new ServiceConfig { Title = "Service", Icon = "üìã" });
    }

    private string GetTierOrRuntime(string serviceType, string runtime)
    {
        return serviceType switch
        {
            "functions" or "appservices" => string.IsNullOrEmpty(runtime) ? ".NET 6" : runtime,
            "storage" => "Standard LRS",
            "cosmosdb" => "SQL API",
            "apimanagement" => "Developer Tier",
            "keyvault" => "Standard",
            "appinsights" => "App Insights",
            _ => "Standard"
        };
    }

    private string GetDefaultStatus(string serviceType)
    {
        return serviceType switch
        {
            "storage" => "Active",
            "cosmosdb" or "apimanagement" or "appinsights" or "keyvault" => "Online",
            _ => "Running"
        };
    }

    public class ServiceConfig
    {
        public string Title { get; set; } = "";
        public string Icon { get; set; } = "";
    }
}